<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8"/>
    <title>Mock ChatMessage - Protobuf WebSocket</title>
    <script src="https://cdn.jsdelivr.net/npm/protobufjs@7.2.4/dist/protobuf.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #101010;
            color: #f0f0f0;
            margin: 0;
            padding: 20px;
        }

        h2 {
            color: #00ffc3;
        }

        input, button {
            margin: 5px;
            padding: 8px;
            border-radius: 6px;
            border: none;
        }

        button {
            background-color: #00b7ff;
            color: white;
            cursor: pointer;
        }

        button:hover {
            background-color: #0088cc;
        }

        #chatBox {
            width: 100%;
            height: 300px;
            overflow-y: auto;
            background: #1a1a1a;
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 14px;
        }

        .msg {
            margin: 5px 0;
            padding: 6px 10px;
            border-radius: 6px;
            word-wrap: break-word;
        }

        .msg.in {
            background-color: #2d2d2d;
            color: #00ffae;
        }

        .msg.out {
            background-color: #004d66;
            color: #ffffff;
            text-align: right;
        }

        #log {
            background: #111;
            color: #ccc;
            padding: 8px;
            border-radius: 6px;
            height: 150px;
            overflow-y: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
<h2>Mock ChatMessage via WebSocket (Protobuf)</h2>

<div>
    <input type="text" id="remetente" placeholder="Usu√°rio remetente">
    <input type="text" id="destinatario" placeholder="Usu√°rio destino">
    <button id="connect">Conectar</button>
    <button id="send">Enviar Mock</button>
</div>

<div id="chatBox"></div>

<h3>Logs</h3>
<pre id="log"></pre>

<script>
    const log = (msg) => {
        const el = document.getElementById('log');
        el.textContent += msg + "\n";
        el.scrollTop = el.scrollHeight;
    };

    const addChatMsg = (content, type) => {
        const box = document.getElementById('chatBox');
        const div = document.createElement('div');
        div.className = `msg ${type}`;
        div.textContent = content;
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
    };

    let ws;
    let ChatMessage;

    // 1Ô∏è‚É£ Carrega o schema protobuf
    protobuf.load("/proto/chat_message.proto").then(root => {
        ChatMessage = root.lookupType("ChatMessage");
        log("‚úÖ Proto carregado com sucesso!");
    });

    // 2Ô∏è‚É£ Conectar WebSocket
    document.getElementById('connect').onclick = () => {
        const senderId = document.getElementById('remetente').value;
        if (!senderId) {
            alert("Informe o remetente antes de conectar!");
            return;
        }

        ws = new WebSocket("ws://localhost:8084/ws-chat?userId=" + senderId);
        ws.binaryType = "arraybuffer";

        ws.onopen = () => log("üîó Conectado ao servidor WebSocket!");
        ws.onmessage = (event) => {
            if (event.data instanceof ArrayBuffer) {
                const bytes = new Uint8Array(event.data);
                const msg = ChatMessage.decode(bytes);
                addChatMsg(`üí¨ ${msg.senderId}: ${msg.content}`, "in");
                log("üì© Mensagem recebida: " + JSON.stringify(msg, null, 2));
            } else {
                log("üìÑ Texto recebido: " + event.data);
            }
        };
        ws.onclose = () => log("‚ùå Conex√£o encerrada");
    };

    // 3Ô∏è‚É£ Enviar mock de mensagem
    document.getElementById('send').onclick = () => {
        const senderId = Number(document.getElementById('remetente').value);
        const destinyId = Number(document.getElementById('destinatario').value);

        if (!ws || ws.readyState !== WebSocket.OPEN) {
            log("‚ö†Ô∏è WebSocket n√£o est√° conectado.");
            return;
        }

        if (!ChatMessage) {
            log("‚ö†Ô∏è Proto ainda n√£o carregado.");
            return;
        }

        const mockMessage = {
            messageId: crypto.randomUUID(),
            conversationId: "conv-001",
            senderId,
            content: "Mensagem de teste enviada √†s " + new Date().toLocaleTimeString(),
            timestamp: new Date().toISOString(),
            destinyId
        };

        const err = ChatMessage.verify(mockMessage);
        if (err) {
            log("Erro na mensagem: " + err);
            return;
        }

        const messageBuffer = ChatMessage.encode(ChatMessage.create(mockMessage)).finish();
        ws.send(messageBuffer);

        addChatMsg(`üì§ Voc√™: ${mockMessage.content}`, "out");
        log("üì§ Mensagem enviada (bytes): " + messageBuffer.length + " bytes");
    };
</script>
</body>
</html>
